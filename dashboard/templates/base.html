{% load static tailwind_tags %}
{% load leaflet_tags %}
<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
<head>
    <title>Ai Powered Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
 <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js" integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz" crossorigin="anonymous"></script>
<script src="https://cdn.plot.ly/plotly-3.3.0.min.js" charset="utf-8"></script>
<script src="{% static 'js/htmx-ext-response-targets.min.js' %}"></script>
{% leaflet_js %} 
{% leaflet_css %} 
{% tailwind_css %}
</head>

<body hx-ext="response-targets" class="leading-normal tracking-normal" hx-headers='{"x-csrftoken":"{{csrf_token}}"}'>
  <div class="flex">
    <div class="w-[40%]">
      {% leaflet_map "map" %}
      <script>
        window.addEventListener('map:init', function(e) {
          const map = e.detail.map
          if (typeof map !== 'undefined') {
            fetch('/raster/json/')
              .then(response => response.json())
              .then(data => {
                // data.bounds is [minX, minY, maxX, maxY]
                const b = data.bounds;
                // Convert to Leaflet bounds: [[southWest_lat, southWest_lng], [northEast_lat, northEast_lng]]
                const leafletBounds = [[b[1], b[0]], [b[3], b[2]]];
                map.fitBounds(leafletBounds);

                // Add the TiTiler raster overlay with some transparency
                L.tileLayer(data.tiles[0], {
                  tileSize: 256,
                  opacity: 0.9,
                  maxZoom: data.maxzoom
                }).addTo(map);
              })
              .catch(error => console.error('Error loading raster:', error));
          }
        });
      </script>
    </div>
    <div class="w-[60%] flex grow flex-col gap-3 items-center p-6">
      <h1 class="text-3xl font-bold mx-auto">AI Powered Dashboard</h1>
      <div class="w-full flex flex-col gap-3"> 
        {% include "headline_stats.html" %}
    <div class="flex w-full flex-col">
    {% include "includes/chart.html" with module=default_module metric=default_module.filters.1.values.0.label %}

  <div class="w-full p-4 bg-base-200 rounded-box shadow-lg">
    <h2 class="text-lg font-bold mb-2">Ask the Data</h2>
    
    <form hx-post="{% url 'chatbot:ask_ai' %}" 
          hx-target="#ai-response" 
          hx-indicator="#ai-loading"
          class="flex gap-2">
        {% csrf_token %}
        <input type="text" 
               name="query" 
               placeholder="e.g., 'What was the wheat yield in 2025?'" 
               class="input input-bordered w-full" 
               required>
        <button type="submit" class="btn btn-primary text-white">
            Ask
        </button>
    </form>
    <div id="ai-loading" class="htmx-indicator w-full mt-2">
        <span class="loading loading-dots loading-sm"></span> Thinking...
    </div>

    <div id="ai-response" class="prose text-sm"></div>
</div>
</div>

  </div>
</body>
</html>
